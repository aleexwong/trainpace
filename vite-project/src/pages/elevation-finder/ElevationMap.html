<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX Route Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: #ecf0f1;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        #map {
            height: 500px;
            width: 100%;
        }
        
        .leaflet-popup-content {
            font-size: 14px;
        }
        
        .elevation-marker {
            background: #e74c3c;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .success-message {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è GPX Route Viewer</h1>
            <p>Upload your GPX data to visualize routes on OpenStreetMap</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="gpxInput">GPX Data (paste your GPX XML here):</label>
                <textarea id="gpxInput" placeholder="Paste your GPX XML data here...">&lt;gpx version="1.1" creator="example"&gt;&lt;trk&gt;&lt;name&gt;Test Track&lt;/name&gt;&lt;trkseg&gt;&lt;trkpt lat="49.2827" lon="-123.1207"&gt;&lt;ele&gt;10&lt;/ele&gt;&lt;/trkpt&gt;&lt;trkpt lat="49.2830" lon="-123.1210"&gt;&lt;ele&gt;15&lt;/ele&gt;&lt;/trkpt&gt;&lt;trkpt lat="49.2835" lon="-123.1215"&gt;&lt;ele&gt;20&lt;/ele&gt;&lt;/trkpt&gt;&lt;trkpt lat="49.2840" lon="-123.1220"&gt;&lt;ele&gt;25&lt;/ele&gt;&lt;/trkpt&gt;&lt;trkpt lat="49.2845" lon="-123.1225"&gt;&lt;ele&gt;30&lt;/ele&gt;&lt;/trkpt&gt;&lt;/trkseg&gt;&lt;/trk&gt;&lt;/gpx&gt;</textarea>
            </div>
            
            <button onclick="loadGPX()">üìç Load Route</button>
            <button onclick="clearMap()">üóëÔ∏è Clear Map</button>
            <button onclick="loadSampleData()">üìã Load Sample Data</button>
            
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
            
            <div id="routeStats" class="stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="totalDistance">0</div>
                    <div class="stat-label">Distance (km)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-label">Track Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="elevationGain">0</div>
                    <div class="stat-label">Elevation Gain (m)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxElevation">0</div>
                    <div class="stat-label">Max Elevation (m)</div>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Initialize the map
        let map = L.map('map').setView([49.2827, -123.1207], 13);
        let currentRoute = null;
        let markers = [];

        // Add OpenStreetMap tile layer with proper attribution and fallback
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
            subdomains: ['a', 'b', 'c']
        }).addTo(map);
        
        // Add a fallback tile layer in case OSM doesn't work
        const fallbackLayer = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ¬© <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 18,
            subdomains: ['a', 'b', 'c', 'd']
        });
        
        // Try to detect if tiles are loading, if not switch to fallback
        let tilesLoaded = false;
        map.on('tileload', function() {
            tilesLoaded = true;
        });
        
        // Check after 3 seconds if tiles loaded, if not use fallback
        setTimeout(() => {
            if (!tilesLoaded) {
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                fallbackLayer.addTo(map);
                console.log('Switched to fallback tile provider');
            }
        }, 3000);

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function parseGPX(gpxText) {
            try {
                const parser = new DOMParser();
                const gpxDoc = parser.parseFromString(gpxText, 'text/xml');
                
                // Check for parsing errors
                const parserError = gpxDoc.querySelector('parsererror');
                if (parserError) {
                    throw new Error('Invalid XML format');
                }
                
                const trackPoints = gpxDoc.querySelectorAll('trkpt');
                const trackName = gpxDoc.querySelector('name')?.textContent || 'Unnamed Track';
                
                if (trackPoints.length === 0) {
                    throw new Error('No track points found in GPX data');
                }
                
                const coordinates = [];
                let totalDistance = 0;
                let elevationGain = 0;
                let maxElevation = -Infinity;
                let lastElevation = null;
                
                trackPoints.forEach((point, index) => {
                    const lat = parseFloat(point.getAttribute('lat'));
                    const lon = parseFloat(point.getAttribute('lon'));
                    const ele = parseFloat(point.querySelector('ele')?.textContent || 0);
                    
                    if (isNaN(lat) || isNaN(lon)) {
                        throw new Error(`Invalid coordinates at point ${index + 1}`);
                    }
                    
                    coordinates.push({
                        lat: lat,
                        lng: lon,
                        ele: ele
                    });
                    
                    // Calculate distance
                    if (index > 0) {
                        const prevPoint = coordinates[index - 1];
                        const distance = calculateDistance(prevPoint.lat, prevPoint.lng, lat, lon);
                        totalDistance += distance;
                    }
                    
                    // Calculate elevation gain
                    if (lastElevation !== null && ele > lastElevation) {
                        elevationGain += (ele - lastElevation);
                    }
                    lastElevation = ele;
                    
                    // Track max elevation
                    if (ele > maxElevation) {
                        maxElevation = ele;
                    }
                });
                
                return {
                    name: trackName,
                    coordinates: coordinates,
                    totalDistance: totalDistance,
                    elevationGain: elevationGain,
                    maxElevation: maxElevation === -Infinity ? 0 : maxElevation
                };
            } catch (error) {
                throw new Error(`GPX parsing error: ${error.message}`);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function loadGPX() {
            const gpxInput = document.getElementById('gpxInput').value.trim();
            
            if (!gpxInput) {
                showError('Please paste GPX data first');
                return;
            }
            
            try {
                const gpxData = parseGPX(gpxInput);
                displayRoute(gpxData);
                updateStats(gpxData);
                showSuccess(`Route "${gpxData.name}" loaded successfully!`);
            } catch (error) {
                showError(error.message);
            }
        }

        function displayRoute(gpxData) {
            // Clear existing route and markers
            clearMap();
            
            const coordinates = gpxData.coordinates;
            const latLngs = coordinates.map(coord => [coord.lat, coord.lng]);
            
            // Create the route polyline
            currentRoute = L.polyline(latLngs, {
                color: '#e74c3c',
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);
            
            // Add start marker
            const startMarker = L.marker([coordinates[0].lat, coordinates[0].lng], {
                icon: L.divIcon({
                    html: 'üèÅ',
                    className: 'start-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            startMarker.bindPopup(`
                <b>Start Point</b><br>
                Lat: ${coordinates[0].lat.toFixed(6)}<br>
                Lng: ${coordinates[0].lng.toFixed(6)}<br>
                Elevation: ${coordinates[0].ele.toFixed(1)}m
            `);
            
            markers.push(startMarker);
            
            // Add end marker
            const endCoord = coordinates[coordinates.length - 1];
            const endMarker = L.marker([endCoord.lat, endCoord.lng], {
                icon: L.divIcon({
                    html: 'üèÅ',
                    className: 'end-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            endMarker.bindPopup(`
                <b>End Point</b><br>
                Lat: ${endCoord.lat.toFixed(6)}<br>
                Lng: ${endCoord.lng.toFixed(6)}<br>
                Elevation: ${endCoord.ele.toFixed(1)}m
            `);
            
            markers.push(endMarker);
            
            // Add elevation markers for significant points
            const elevationMarkers = coordinates.filter((coord, index) => {
                return index % Math.max(1, Math.floor(coordinates.length / 10)) === 0;
            });
            
            elevationMarkers.forEach((coord, index) => {
                const marker = L.marker([coord.lat, coord.lng], {
                    icon: L.divIcon({
                        html: `<div class="elevation-marker">${Math.round(coord.ele)}</div>`,
                        className: 'elevation-marker-container',
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <b>Elevation Point</b><br>
                    Lat: ${coord.lat.toFixed(6)}<br>
                    Lng: ${coord.lng.toFixed(6)}<br>
                    Elevation: ${coord.ele.toFixed(1)}m
                `);
                
                markers.push(marker);
            });
            
            // Fit map to route bounds
            map.fitBounds(currentRoute.getBounds(), { padding: [20, 20] });
        }

        function updateStats(gpxData) {
            document.getElementById('totalDistance').textContent = gpxData.totalDistance.toFixed(2);
            document.getElementById('totalPoints').textContent = gpxData.coordinates.length;
            document.getElementById('elevationGain').textContent = gpxData.elevationGain.toFixed(1);
            document.getElementById('maxElevation').textContent = gpxData.maxElevation.toFixed(1);
            document.getElementById('routeStats').style.display = 'flex';
        }

        function clearMap() {
            if (currentRoute) {
                map.removeLayer(currentRoute);
                currentRoute = null;
            }
            
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
            
            document.getElementById('routeStats').style.display = 'none';
        }

        function loadSampleData() {
            document.getElementById('gpxInput').value = `<gpx version="1.1" creator="example">
<trk>
<name>Vancouver Seawall Sample</name>
<trkseg>
<trkpt lat="49.2827" lon="-123.1207"><ele>10</ele></trkpt>
<trkpt lat="49.2830" lon="-123.1210"><ele>15</ele></trkpt>
<trkpt lat="49.2835" lon="-123.1215"><ele>20</ele></trkpt>
<trkpt lat="49.2840" lon="-123.1220"><ele>25</ele></trkpt>
<trkpt lat="49.2845" lon="-123.1225"><ele>30</ele></trkpt>
<trkpt lat="49.2850" lon="-123.1230"><ele>35</ele></trkpt>
<trkpt lat="49.2855" lon="-123.1235"><ele>40</ele></trkpt>
<trkpt lat="49.2860" lon="-123.1240"><ele>45</ele></trkpt>
<trkpt lat="49.2865" lon="-123.1245"><ele>50</ele></trkpt>
<trkpt lat="49.2870" lon="-123.1250"><ele>55</ele></trkpt>
</trkseg>
</trk>
</gpx>`;
        }

        // Load sample data on page load
        window.onload = function() {
            loadSampleData();
            loadGPX();
        };
    </script>
</body>
</html>